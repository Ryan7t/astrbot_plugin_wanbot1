# QQ机器人消息按钮开发指南

## 什么是消息按钮？

消息按钮是QQ机器人发送的消息下方显示的可点击按钮，用户点击后可以触发特定的操作，提供更好的交互体验。

## 效果展示
![alt text](images/image.png)

## 接口信息

**接口地址**: `POST /channels/{channel_id}/messages`

**Content-Type**: `application/json`

## 功能描述

通过指定 `keyboard` 字段发送带按钮的消息，支持 `keyboard` 模版 和 `自定义 keyboard` 两种请求格式。

### 重要限制和要求
- 要求操作人在该子频道具有发送消息和对应消息按钮组件的权限
- 请求参数 `keyboard` 模版 和 `自定义 keyboard` 只能单一传值
- `keyboard` 模版调用前需要先申请消息按钮组件模板，获得模板 ID
- 申请消息按钮组件模板需要提供响应的 JSON，具体格式参考 `InlineKeyboard`
- **仅 `markdown` 消息支持消息按钮**

### 两种实现方式

#### 1. 模板按钮（推荐）
- 需要先在QQ开放平台申请按钮模板
- 获得模板ID后在请求中使用
- 相对简单，审核通过后即可使用

#### 2. 自定义按钮（已停止开放）
- 可以完全自定义按钮的样式和行为
- 目前不再新增对外开放，新用户无法使用

## 按钮配置字段详解

### 核心结构说明

#### 1. **id（按钮唯一标识）**
- **类型**: string
- **作用**: 每个按钮的唯一编号，用于区分不同的按钮
- **要求**: 同一个模板中不能重复
- **示例**: `"id": "1"` 或 `"id": "answer_book"`

#### 2. **render_data（渲染数据）**
按钮显示相关的配置：

##### **label（按钮标签）**
- **类型**: string
- **作用**: 按钮初始显示的文字
- **示例**: `"label": "📖 答案之书"`
- **建议**: 使用emoji让按钮更美观

##### **visited_label（访问后标签）**
- **类型**: string
- **作用**: 用户点击按钮后，按钮上显示的文字
- **效果**: 给用户视觉反馈，表明已经点击过
- **示例**:
  - 点击前: `"📖 答案之书"`
  - 点击后: `"📖 答案之书 ✓"`

#### 3. **action（动作配置）**
按钮点击后的行为设置：

##### **type（动作类型）**
- **类型**: number
- **常用值**: `2` (发送消息)
- **作用**: 定义点击按钮后执行的动作类型

##### **data（执行数据）**
- **类型**: string
- **作用**: 用户点击按钮后，自动发送的消息内容
- **示例**: `"/答案之书 我今天会遇到好事吗？"`
- **说明**: 相当于用户手动输入这条指令

##### **unsupport_tips（不支持提示）**
- **类型**: string
- **作用**: 当用户的QQ版本不支持按钮功能时显示的提示文字
- **使用场景**:
  - 用户QQ版本过旧
  - 设备不支持按钮功能
  - 网络问题导致按钮无法正常工作
- **示例**: `"您的QQ版本不支持按钮功能，请手动输入：/答案之书 [您的问题]"`
- **建议**: 提供替代方案，包含具体的操作指引

##### **permission（权限设置）**
- **类型**: object
- **作用**: 控制哪些用户可以点击这个按钮
- **常用配置**:
  ```json
  "permission": {
    "type": 2,
    "specify_role_ids": ["1", "2", "3"]
  }
  ```
- **说明**:
  - `type: 2` 通常表示指定角色才能使用
  - `specify_role_ids` 是具体的角色ID列表

##### **click_limit（点击限制）**
- **类型**: number
- **作用**: 限制按钮的点击次数
- **示例**: `"click_limit": 10`

##### **at_bot_show_channel_list（显示频道列表）**
- **类型**: boolean
- **作用**: 是否在@机器人时显示频道列表
- **示例**: `"at_bot_show_channel_list": true`

## 申请模板流程

### 第一步：申请 Markdown 模板
1. 在QQ开放平台找到 "markdown模板" 申请入口
2. 填写模板信息：
   - **模板名称**: 如 "小万bot帮助消息"
   - **使用场景**: 如 "用于显示机器人功能介绍和操作指引"
3. 在 **markdown源码** 中填写：
   ```markdown
   # {{title}}

   {{content}}

   请选择您需要的功能：
   ```

### 第二步：申请消息按钮模板
1. 在QQ开放平台找到 "消息按钮模板" 申请入口
2. 填写模板信息：
   - **模板名称**: 如 "小万bot功能按钮"
   - **使用场景**: 如 "提供快捷功能选择按钮"
3. 在 **JSON源码** 中填写按钮配置（参考下方完整示例）

### 第三步：等待审核
- 审核时间：通常1-3个工作日
- 审核通过后获得：
  - Markdown模板ID（如：123）
  - 按钮模板ID（如：456）

## 使用示例

### 模板按钮请求格式

```json
{
  "markdown": {
    "template_id": 1,
    "params": [{
        "key": "title",
        "value": ["标题"]
      }
    ]
  },
  "msg_id": "xxxxxx",
  "keyboard": {
    "id": "123"
  }
}
```

**字段说明**：
- `template_id`: Markdown模板的ID
- `params`: 模板参数，用于填充模板中的变量
- `keyboard.id`: 按钮模板的ID

### 完整的按钮模板JSON示例

适合 wanbot1 插件的按钮配置：

```json
{
  "rows": [
    {
      "buttons": [
        {
          "id": "answer_book",
          "render_data": {
            "label": "📖 答案之书",
            "visited_label": "📖 答案之书 ✓"
          },
          "action": {
            "type": 2,
            "permission": {
              "type": 2
            },
            "data": "/答案之书 我今天会遇到好事吗？",
            "unsupport_tips": "您的QQ版本不支持按钮功能，请手动输入：/答案之书 [您的问题]"
          }
        },
        {
          "id": "story",
          "render_data": {
            "label": "📚 一句话故事",
            "visited_label": "📚 故事功能 ✓"
          },
          "action": {
            "type": 2,
            "permission": {
              "type": 2
            },
            "data": "/一句话故事 友情",
            "unsupport_tips": "您的QQ版本不支持按钮功能，请手动输入：/一句话故事 [主题]"
          }
        }
      ]
    },
    {
      "buttons": [
        {
          "id": "fortune",
          "render_data": {
            "label": "🔮 今日运势",
            "visited_label": "🔮 运势已查看 ✓"
          },
          "action": {
            "type": 2,
            "permission": {
              "type": 2
            },
            "data": "/今日运势",
            "unsupport_tips": "您的QQ版本不支持按钮功能，请手动输入：/今日运势"
          }
        },
        {
          "id": "help",
          "render_data": {
            "label": "❓ 使用帮助",
            "visited_label": "❓ 帮助已查看 ✓"
          },
          "action": {
            "type": 2,
            "permission": {
              "type": 2
            },
            "data": "/帮助",
            "unsupport_tips": "您的QQ版本不支持按钮功能，请手动输入：/帮助"
          }
        }
      ]
    }
  ]
}
```

## 设计建议

### 1. **按钮布局建议**
- 每行最多2-3个按钮，避免过于拥挤
- 相关功能放在同一行
- 重要功能放在第一行
- 建议布局：
  ```
  [📖 答案之书] [📚 一句话故事]
  [🔮 今日运势] [❓ 使用帮助]
  ```

### 2. **文案设计建议**

#### **label 设计**
- 使用emoji让按钮更美观
- 保持简洁明了
- 体现功能特点

#### **visited_label 设计**
- 简洁明了，让用户知道已经点击过
- 可以加上 ✓、✅ 等符号表示已完成
- 保持与原标签的一致性

#### **unsupport_tips 设计**
- 提供替代方案（手动输入指令）
- 语言友好，不要让用户感到困惑
- 包含具体的操作指引

### 3. **权限设置建议**
- 一般情况下使用 `"type": 2` 即可
- 如需限制特定用户，配置 `specify_role_ids`
- 考虑用户体验，避免过度限制

## 注意事项

### 平台限制
- 消息按钮只在QQ官方机器人接口中有效
- 个人QQ号（如通过NapCat等）不支持此功能
- 需要机器人有发送消息和消息按钮组件的权限

### 格式要求
- 必须使用markdown消息格式
- 需要同时申请markdown模板和按钮模板

### 审核要求
- 按钮的功能要与申请时描述的场景一致
- 提供的示例要真实可用
- 遵守QQ平台的相关规范

## API 响应格式

成功发送带按钮的消息后，会返回标准的 `Message` 对象：

```json
{
    "id": "101234567890abcdef",
    "channel_id": "10001",
    "guild_id": "6400000001",
    "content": "",
    "timestamp": "2021-05-13T14:45:45+08:00",
    "tts": false,
    "mention_everyone": false,
    "author": {
        "id": "12345",
        "username": "abc",
        "avatar": "",
        "bot": true
    },
    "pinned": false,
    "type": 0,
    "flags": 0
}
```

**响应字段说明**：
- `id`: 消息的唯一标识符
- `channel_id`: 频道ID
- `guild_id`: 服务器ID
- `timestamp`: 消息发送时间
- `author`: 发送者信息（机器人）
- `type`: 消息类型
- `flags`: 消息标志位

## 常见错误码

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 400 | 请求参数错误 | 检查JSON格式和必填字段 |
| 401 | 未授权 | 检查机器人token是否正确 |
| 403 | 权限不足 | 确认机器人有发送消息和按钮组件权限 |
| 404 | 模板不存在 | 检查模板ID是否正确，是否已审核通过 |
| 429 | 请求频率限制 | 降低请求频率，遵守API限制 |

## 总结

消息按钮功能可以大大提升用户体验，让用户通过点击按钮快速使用机器人功能。对于 wanbot1 插件来说，合理使用按钮可以：

1. **简化操作**：用户无需记住复杂的指令格式
2. **提高效率**：一键触发常用功能
3. **改善体验**：直观的图形界面更友好
4. **减少错误**：避免用户输入错误的指令

记住要先申请模板，等待审核通过后才能在代码中使用。祝你的机器人开发顺利！